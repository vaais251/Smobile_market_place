# ──────────────────────────────────────────────
# SMobile — Nginx Reverse Proxy Configuration
# ──────────────────────────────────────────────
# Routes:
#   /api/*    → FastAPI backend  (http://backend:8000)
#   /static/* → FastAPI static   (http://backend:8000)
#   /ws/*     → WebSocket proxy  (http://backend:8000)
#   /*        → Next.js frontend (http://frontend:3000)
# ──────────────────────────────────────────────

upstream backend_upstream {
    server backend:8000;
}

upstream frontend_upstream {
    server frontend:3000;
}

server {
    listen 80;
    server_name _;

    # ── Security Headers ─────────────────────
    add_header X-Frame-Options        "SAMEORIGIN"       always;
    add_header X-Content-Type-Options "nosniff"           always;
    add_header X-XSS-Protection       "1; mode=block"    always;
    add_header Referrer-Policy        "strict-origin-when-cross-origin" always;

    # ── Client Upload Limits ─────────────────
    client_max_body_size 20M;

    # ── API Routes → Backend ─────────────────
    location /api/ {
        proxy_pass         http://backend_upstream;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # WebSocket support for /api/v1/chat/ws/*
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # ── Static Files → Backend ───────────────
    location /static/ {
        proxy_pass         http://backend_upstream;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_cache_valid  200 1d;
    }

    # ── Everything Else → Frontend ───────────
    location / {
        proxy_pass         http://frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        # Next.js HMR / WebSocket (needed for _next/webpack-hmr in dev)
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
    }
}
